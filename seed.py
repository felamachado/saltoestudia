from sqlmodel import Session, select
import reflex as rx
import bcrypt
import os
from sqlmodel import select, delete
# Importamos ambos modelos, Institucion y Usuario
from saltoestudia.models import Institucion, Usuario, Curso
from saltoestudia.constants import CursosConstants
from saltoestudia.database import agregar_curso, engine  # Ahora s√≠ se puede importar

def hash_password(password: str) -> str:
    """Hashea una contrase√±a usando bcrypt."""
    # El salt se genera y se incluye en el hash final
    hashed_bytes = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt())
    return hashed_bytes.decode('utf-8')

def get_default_seed_password():
    """
    Obtiene la contrase√±a por defecto para los usuarios de seed desde variables de entorno.
    Si no est√° definida, usa una contrase√±a temporal que debe cambiarse.
    """
    return os.getenv("DEFAULT_SEED_PASSWORD", "temporal_cambiar_2024!")

def create_tables_if_not_exist():
    """Crea las tablas si no existen usando Reflex."""
    try:
        print("üîß Verificando y creando tablas si es necesario...")
        # En Reflex 0.7.14, usar get_db_engine() en lugar de rx.engine
        engine = rx.Model.get_db_engine()
        rx.Model.metadata.create_all(bind=engine)
        print("‚úÖ Tablas verificadas/creadas correctamente.")
        return True
    except Exception as e:
        print(f"‚ùå Error al crear tablas: {e}")
        return False

def seed_database():
    """
    Script idempotente para limpiar y poblar las tablas de instituciones y usuarios.
    
    IMPORTANTE: Este script crea usuarios con contrase√±as por defecto.
    En producci√≥n, cambiar todas las contrase√±as inmediatamente.
    """
    # Primero asegurar que las tablas existen
    if not create_tables_if_not_exist():
        print("‚ùå No se pudieron crear las tablas. Abortando seed.")
        return False

    try:
        with Session(engine) as session:
            # 1. Limpiar las tablas en el orden correcto (hijos antes que padres)
            print("üßπ Limpiando la tabla 'usuarios'...")
            try:
                session.exec(delete(Usuario))
                print("‚úÖ Tabla 'usuarios' limpiada.")
            except Exception as e:
                print(f"‚ö†Ô∏è Error al limpiar usuarios (tabla puede no existir): {e}")
            
            print("üßπ Limpiando la tabla 'instituciones'...")
            try:
                session.exec(delete(Institucion))
                print("‚úÖ Tabla 'instituciones' limpiada.")
            except Exception as e:
                print(f"‚ö†Ô∏è Error al limpiar instituciones (tabla puede no existir): {e}")
            
            # 2. Crear las 5 Instituciones
            print("üè¢ Creando las 5 instituciones iniciales...")
            
            institucion1 = Institucion(
                nombre="UDELAR ‚Äì CENUR LN",
                direccion="Rivera 1350",
                telefono="47334816",
                email="comunicacion@unorte.edu.uy",
                web="https://www.litoralnorte.udelar.edu.uy/",
                logo="/logos/logo-cenur.png"
            )
            
            institucion2 = Institucion(
                nombre="IAE Salto",
                direccion="Misiones 192",
                telefono="47354602",
                email="iaesalto@gmail.com",
                logo="/logos/logoutu.png"
            )
            
            institucion3 = Institucion(
                nombre="Esc. Catalina H. de Casta√±os",
                direccion="Varela 440",
                telefono="47335987",
                email="ttssalto@gmail.com",
                logo="/logos/logoutu.png"
            )

            institucion4 = Institucion(
                nombre="Esc. De Administraci√≥n",
                direccion="Juan C. Gomez 351",
                telefono="47323778",
                email="etays.salto@gmail.com",
                logo="/logos/logoutu.png"
            )

            institucion5 = Institucion(
                nombre="Esc. Agraria",
                direccion="Ruta a Salto Grande S/N",
                telefono="47322862",
                email="esagrariasalto@gmail.com",
                logo="/logos/logoutu.png"
            )
            
            instituciones_a_crear = [institucion1, institucion2, institucion3, institucion4, institucion5]
            session.add_all(instituciones_a_crear)
            print("‚úÖ Instituciones preparadas para creaci√≥n.")

            # 3. Crear los 5 Usuarios y vincularlos a las instituciones
            print("üë• Creando 5 usuarios y vincul√°ndolos...")
            
            # Obtener contrase√±as desde variables de entorno o usar la por defecto
            default_password = get_default_seed_password()
            
            usuario1 = Usuario(
                correo="cenur@cenur.com", 
                password_hash=hash_password(os.getenv("CENUR_PASSWORD", default_password)), 
                institucion=institucion1
            )
            usuario2 = Usuario(
                correo="iae@iae.com", 
                password_hash=hash_password(os.getenv("IAE_PASSWORD", default_password)), 
                institucion=institucion2
            )
            usuario3 = Usuario(
                correo="catalina@catalina.com", 
                password_hash=hash_password(os.getenv("CATALINA_PASSWORD", default_password)), 
                institucion=institucion3
            )
            usuario4 = Usuario(
                correo="administracion@administracion.com", 
                password_hash=hash_password(os.getenv("ADMINISTRACION_PASSWORD", default_password)), 
                institucion=institucion4
            )
            usuario5 = Usuario(
                correo="agraria@agraria.com", 
                password_hash=hash_password(os.getenv("AGRARIA_PASSWORD", default_password)), 
                institucion=institucion5
            )

            usuarios_a_crear = [usuario1, usuario2, usuario3, usuario4, usuario5]
            session.add_all(usuarios_a_crear)
            print("‚úÖ Usuarios preparados para creaci√≥n.")

            # 4. Guardar todo en la base de datos en una sola transacci√≥n
            session.commit()
            
            print("\nüéâ ¬°Base de datos actualizada exitosamente!")
            print(f"üìä Se crearon {len(instituciones_a_crear)} instituciones y {len(usuarios_a_crear)} usuarios.")
            
            # Mostrar informaci√≥n de seguridad
            if default_password == "temporal_cambiar_2024!":
                print("\n‚ö†Ô∏è  IMPORTANTE - SEGURIDAD:")
                print("   Los usuarios fueron creados con contrase√±as temporales.")
                print("   En producci√≥n, cambia todas las contrase√±as inmediatamente.")
                print("   Para usar contrase√±as personalizadas, define estas variables de entorno:")
                print("   - DEFAULT_SEED_PASSWORD (contrase√±a general)")
                print("   - CENUR_PASSWORD, IAE_PASSWORD, CATALINA_PASSWORD, etc.")
            
            print("\nüîë Usuarios creados:")
            for usuario in usuarios_a_crear:
                print(f"   üìß {usuario.correo} - Instituci√≥n: {usuario.institucion.nombre}")
            
            return True
            
    except Exception as e:
        print(f"‚ùå Error durante el seed de la base de datos: {e}")
        return False

def poblar_cursos():
    # Diccionario: nombre de instituci√≥n -> lista de cursos
    cursos_por_institucion = {
        "UDELAR ‚Äì CENUR LN": [
            {"nombre": "Licenciatura en Inform√°tica", "nivel": "Universitario", "duracion_numero": "4", "duracion_unidad": "a√±os", "requisitos_ingreso": "Bachillerato", "informacion": "Programa con fuerte √©nfasis en desarrollo de software y proyectos con clientes reales."},
            {"nombre": "Taller de Introducci√≥n a la Rob√≥tica", "nivel": "Terciario", "duracion_numero": "6", "duracion_unidad": "meses", "requisitos_ingreso": "Ciclo b√°sico", "informacion": "Laboratorio con kits Arduino incluidos y participaci√≥n en competencias locales."},
            {"nombre": "Diplomado en Ciencia de Datos", "nivel": "Posgrado", "duracion_numero": "12", "duracion_unidad": "meses", "requisitos_ingreso": "Universitario", "informacion": "Incluye pr√°cticas en Python, R y uso de herramientas de Big Data."},
            {"nombre": "Curso Intensivo de Redes Cisco", "nivel": "Terciario", "duracion_numero": "3", "duracion_unidad": "meses", "requisitos_ingreso": "Bachillerato", "informacion": "Preparaci√≥n para la certificaci√≥n CCNA; clases 100 % pr√°cticas."},
        ],
        "IAE Salto": [
            {"nombre": "Gesti√≥n de Emprendimientos", "nivel": "Terciario", "duracion_numero": "5", "duracion_unidad": "meses", "requisitos_ingreso": "Bachillerato", "informacion": "Plan de negocios y mentor√≠a con incubadoras locales."},
            {"nombre": "Marketing Digital y E-Commerce", "nivel": "Terciario", "duracion_numero": "4", "duracion_unidad": "meses", "requisitos_ingreso": "Ciclo b√°sico", "informacion": "Se trabaja con campa√±as reales en redes sociales y Google Ads."},
            {"nombre": "Tecnicatura en Administraci√≥n", "nivel": "Bachillerato", "duracion_numero": "2", "duracion_unidad": "a√±os", "requisitos_ingreso": "Ciclo b√°sico", "informacion": "Pr√°cticas profesionales en empresas de la zona."},
            {"nombre": "Curso de Contabilidad con Excel", "nivel": "Bachillerato", "duracion_numero": "2", "duracion_unidad": "meses", "requisitos_ingreso": "Ciclo b√°sico", "informacion": "Incluye plantillas avanzadas y certificaci√≥n interna."},
        ],
        "Esc. Catalina H. de Casta√±os": [
            {"nombre": "Electricidad Domiciliaria", "nivel": "Terciario", "duracion_numero": "4", "duracion_unidad": "meses", "requisitos_ingreso": "Ciclo b√°sico", "informacion": "Pr√°cticas en instalaciones reales y certificaci√≥n oficial."},
            {"nombre": "Plomer√≠a y Gas", "nivel": "Terciario", "duracion_numero": "3", "duracion_unidad": "meses", "requisitos_ingreso": "Ciclo b√°sico", "informacion": "Incluye materiales y herramientas de trabajo."},
            {"nombre": "Carpinter√≠a B√°sica", "nivel": "Terciario", "duracion_numero": "6", "duracion_unidad": "meses", "requisitos_ingreso": "Ciclo b√°sico", "informacion": "Proyectos pr√°cticos y venta de productos realizados."},
            {"nombre": "Mec√°nica Automotriz", "nivel": "Terciario", "duracion_numero": "8", "duracion_unidad": "meses", "requisitos_ingreso": "Ciclo b√°sico", "informacion": "Taller propio con veh√≠culos para pr√°cticas."},
        ],
        "Esc. De Administraci√≥n": [
            {"nombre": "Administraci√≥n de Empresas", "nivel": "Bachillerato", "duracion_numero": "3", "duracion_unidad": "a√±os", "requisitos_ingreso": "Ciclo b√°sico", "informacion": "Formaci√≥n integral en gesti√≥n empresarial."},
            {"nombre": "Contabilidad B√°sica", "nivel": "Terciario", "duracion_numero": "6", "duracion_unidad": "meses", "requisitos_ingreso": "Ciclo b√°sico", "informacion": "Uso de software contable y pr√°cticas en empresas."},
            {"nombre": "Secretariado Ejecutivo", "nivel": "Terciario", "duracion_numero": "2", "duracion_unidad": "a√±os", "requisitos_ingreso": "Ciclo b√°sico", "informacion": "Formaci√≥n en herramientas de oficina y protocolo."},
            {"nombre": "Gesti√≥n de Recursos Humanos", "nivel": "Terciario", "duracion_numero": "1", "duracion_unidad": "a√±o", "requisitos_ingreso": "Bachillerato", "informacion": "Pr√°cticas en empresas y certificaci√≥n en gesti√≥n de personal."},
        ],
        "Esc. Agraria": [
            {"nombre": "T√©cnico Agropecuario", "nivel": "Bachillerato", "duracion_numero": "3", "duracion_unidad": "a√±os", "requisitos_ingreso": "Ciclo b√°sico", "informacion": "Pr√°cticas en campo y laboratorio propio."},
            {"nombre": "Horticultura Org√°nica", "nivel": "Terciario", "duracion_numero": "8", "duracion_unidad": "meses", "requisitos_ingreso": "Ciclo b√°sico", "informacion": "Invernadero experimental y venta de productos."},
            {"nombre": "Ganader√≠a Intensiva", "nivel": "Terciario", "duracion_numero": "6", "duracion_unidad": "meses", "requisitos_ingreso": "Ciclo b√°sico", "informacion": "Pr√°cticas en tambo y granja modelo."},
            {"nombre": "Mecanizaci√≥n Agr√≠cola", "nivel": "Terciario", "duracion_numero": "1", "duracion_unidad": "a√±o", "requisitos_ingreso": "Ciclo b√°sico", "informacion": "Taller de maquinaria agr√≠cola y pr√°cticas en campo."},
        ]
    }
    
    print("üéì Poblando cursos para cada instituci√≥n...")
    
    for nombre_inst, cursos in cursos_por_institucion.items():
        print(f"   üìö Agregando cursos para: {nombre_inst}")
        
        # Buscar la instituci√≥n por nombre
        with Session(engine) as session:
            institucion = session.exec(
                select(Institucion).where(Institucion.nombre == nombre_inst)
            ).first()
            
            if not institucion:
                print(f"   ‚ùå Instituci√≥n no encontrada: {nombre_inst}")
                continue
            
            # Agregar cada curso
            for curso_data in cursos:
                try:
                    # Normalizar unidad de duraci√≥n
                    unidad = curso_data["duracion_unidad"].strip().lower()
                    if unidad in ["a√±o", "a√±os"]:
                        curso_data["duracion_unidad"] = "a√±os"
                    elif unidad in ["mes", "meses"]:
                        curso_data["duracion_unidad"] = "meses"
                    # Agregar el ID de la instituci√≥n al curso
                    curso_data["institucion_id"] = institucion.id
                    # Agregar el curso usando la funci√≥n existente
                    agregar_curso(curso_data)
                    print(f"      ‚úÖ {curso_data['nombre']}")
                except Exception as e:
                    print(f"      ‚ùå Error al agregar {curso_data['nombre']}: {e}")
    
    print("‚úÖ Cursos poblados exitosamente.")

def poblar_base_de_datos():
    """
    Pobla la base de datos con datos iniciales, evitando duplicados.
    """
    with Session(engine) as session:
        print("üîß Verificando y creando datos iniciales (seed)...")

        # --- 1. Crear Instituciones (si no existen) ---
        for data in INSTITUCIONES_DATA:
            institucion_existente = session.exec(select(Institucion).where(Institucion.nombre == data["nombre"])).one_or_none()
            if not institucion_existente:
                institucion = Institucion(**data)
                session.add(institucion)
                print(f"  -> Creada instituci√≥n: {data['nombre']}")
        session.commit()
        print("‚úÖ Instituciones verificadas/creadas.")

        # --- 2. Crear Usuarios (si no existen) ---
        for data in USUARIOS_DATA:
            usuario_existente = session.exec(select(Usuario).where(Usuario.correo == data["correo"])).one_or_none()
            if not usuario_existente:
                institucion = session.exec(select(Institucion).where(Institucion.nombre == data["institucion_nombre"])).one()
                hashed_password = bcrypt.hashpw(data["password"].encode('utf-8'), bcrypt.gensalt()).decode('utf-8')
                usuario = Usuario(
                    correo=data["correo"],
                    password_hash=hashed_password,
                    institucion_id=institucion.id
                )
                session.add(usuario)
                print(f"  -> Creado usuario: {data['correo']} para {institucion.nombre}")
        session.commit()
        print("‚úÖ Usuarios verificados/creados.")
        
        # --- 3. Crear Cursos (si no existen) ---
        for nombre_institucion, cursos in CURSOS_POR_INSTITUCION.items():
            institucion = session.exec(select(Institucion).where(Institucion.nombre == nombre_institucion)).one_or_none()
            if not institucion:
                print(f"  ‚ö†Ô∏è  No se encontr√≥ la instituci√≥n '{nombre_institucion}' para agregar cursos.")
                continue

            print(f"üìö Agregando cursos para: {institucion.nombre}")
            for curso_data in cursos:
                curso_existente = session.exec(select(Curso).where(Curso.nombre == curso_data["nombre"], Curso.institucion_id == institucion.id)).one_or_none()
                if not curso_existente:
                    # Normalizar unidad
                    unidad = curso_data.get("duracion_unidad", "").strip().lower()
                    if unidad in ["a√±o", "a√±os"]:
                        curso_data["duracion_unidad"] = "a√±os"
                    elif unidad in ["mes", "meses"]:
                        curso_data["duracion_unidad"] = "meses"

                    nuevo_curso = Curso(
                        nombre=curso_data["nombre"],
                        nivel=curso_data["nivel"],
                        duracion_numero=str(curso_data["duracion_numero"]),
                        duracion_unidad=curso_data["duracion_unidad"],
                        requisitos_ingreso=curso_data["requisitos_ingreso"],
                        info_adicional=curso_data.get("info_adicional"),
                        institucion_id=institucion.id
                    )
                    session.add(nuevo_curso)
                    print(f"  -> Creado curso: {curso_data['nombre']}")
        
        session.commit()
        print("‚úÖ Cursos verificados/creados.")
        print("\nüéâ ¬°Seed completado exitosamente!\n")

if __name__ == "__main__":
    success = seed_database()
    if success:
        print("\n‚úÖ Seed completado exitosamente.")
        poblar_cursos()
        print("‚úÖ Cursos de ejemplo precargados correctamente.")
        poblar_base_de_datos()
    else:
        print("\n‚ùå Seed fall√≥. Revisa los errores anteriores.")
        exit(1)