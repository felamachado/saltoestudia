name: ğŸš€ Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”‘ Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
        
    - name: ğŸš€ Deploy to VPS
      env:
        VPS_HOST: ${{ secrets.VPS_HOST }}
        VPS_USER: ${{ secrets.VPS_USER }}
      run: |
        echo "ğŸš€ Iniciando despliegue en producciÃ³n..."
        
        # Crear directorio temporal para archivos
        mkdir -p deploy-files
        
        # Copiar archivos necesarios
        cp docker-compose.yml deploy-files/
        cp dockerfile.frontend deploy-files/
        cp dockerfile.backend deploy-files/
        cp scripts/sync-database.sh deploy-files/
        cp requirements.txt deploy-files/
        cp package.json deploy-files/
        cp -r saltoestudia/ deploy-files/
        cp -r alembic/ deploy-files/
        cp alembic.ini deploy-files/
        cp seed.py deploy-files/
        cp rxconfig.py deploy-files/
        
        # Subir archivos al VPS
        echo "ğŸ“¤ Subiendo archivos al VPS..."
        scp -r deploy-files/* $VPS_USER@$VPS_HOST:/srv/docker/saltoestudia/
        
        # Ejecutar despliegue en el VPS
        echo "ğŸ”§ Ejecutando despliegue..."
        ssh $VPS_USER@$VPS_HOST << 'EOF'
          cd /srv/docker/saltoestudia
          
          echo "ğŸ”„ Deteniendo contenedores actuales..."
          docker compose down
          
          echo "ğŸ—ï¸ Reconstruyendo contenedores..."
          docker compose build --no-cache
          
          echo "ğŸš€ Levantando servicios..."
          docker compose up -d
          
          echo "â³ Esperando que los servicios estÃ©n listos..."
          sleep 30
          
          echo "ğŸ” Verificando estado de los servicios..."
          docker compose ps
          
          echo "ğŸ“Š Verificando logs del backend..."
          docker compose logs backend --tail=20
          
          echo "âœ… Despliegue completado"
        EOF
        
        echo "ğŸ‰ Despliegue exitoso en https://saltoestudia.infra.com.uy"
        
    - name: ğŸ” Health Check
      run: |
        echo "ğŸ” Verificando que la aplicaciÃ³n estÃ© funcionando..."
        sleep 60  # Esperar a que todo estÃ© listo
        
        # Verificar que la web responde
        if curl -f -s https://saltoestudia.infra.com.uy > /dev/null; then
          echo "âœ… La aplicaciÃ³n estÃ¡ respondiendo correctamente"
        else
          echo "âŒ La aplicaciÃ³n no estÃ¡ respondiendo"
          exit 1
        fi
        
    - name: ğŸ“§ Notify Success
      if: success()
      run: |
        echo "ğŸ‰ Despliegue exitoso en https://saltoestudia.infra.com.uy"
        echo "ğŸ“… Fecha: $(date)"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        
    - name: ğŸ“§ Notify Failure
      if: failure()
      run: |
        echo "âŒ Despliegue fallÃ³"
        echo "ğŸ“… Fecha: $(date)"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        echo "ğŸ“‹ Revisar logs para mÃ¡s detalles" 
