name: ğŸš€ Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Permite ejecutar manualmente

jobs:
  deploy:
    name: ğŸ³ Deploy Salto Estudia
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”‘ Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/github_actions_deploy_v2
        chmod 600 ~/.ssh/github_actions_deploy_v2
        ssh-keyscan -H ${{ secrets.VPS_HOST_IP }} >> ~/.ssh/known_hosts
        
    - name: ğŸ“ Create .env file
      run: |
        echo "${{ secrets.ENV_FILE }}" > .env
        
    - name: ğŸš€ Deploy to VPS
      env:
        VPS_HOST: ${{ secrets.VPS_HOST }}
        VPS_HOST_IP: ${{ secrets.VPS_HOST_IP }}
      run: |
        # Hacer el script ejecutable
        chmod +x deploy-to-vps.sh
        
        # Ejecutar deployment
        ./deploy-to-vps.sh
        
    - name: âœ… Deployment Status
      if: success()
      run: |
        echo "ğŸ‰ Â¡Deployment exitoso!"
        echo "âœ… AplicaciÃ³n disponible en: https://saltoestudia.infra.com.uy"
        
    - name: âŒ Deployment Failed
      if: failure()
      run: |
        echo "ğŸ’¥ Deployment fallÃ³. Revisa los logs arriba."
        exit 1 
