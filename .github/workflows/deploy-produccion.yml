name: ğŸš€ Deploy ProducciÃ³n to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Agregar VPS a known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan ${{ secrets.VPS_HOST_IP }} >> ~/.ssh/known_hosts

      - name: Debug - Mostrar llaves cargadas en el agente
        run: ssh-add -l

      - name: Debug - Mostrar known_hosts
        run: cat ~/.ssh/known_hosts

      - name: Copiar archivos al VPS (rsync)
        run: |
          rsync -avz --delete --exclude='.git*' --exclude='data/' --exclude='logs/' --exclude='.env' ./ ${{ secrets.VPS_HOST }}:/srv/docker/saltoestudia/

      - name: Verificar estructura del VPS
        run: |
          ssh ${{ secrets.VPS_HOST }} '
            echo "ğŸ“ Verificando estructura del VPS..."
            ls -la /srv/docker/
            echo "ğŸ³ Verificando red Traefik..."
            docker network ls | grep traefik || echo "âš ï¸ Red Traefik no encontrada"
            echo "ğŸ“Š Verificando contenedores activos..."
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          '

      - name: Ejecutar deploy en el VPS
        run: |
          ssh ${{ secrets.VPS_HOST }} '
            echo "ğŸš€ Iniciando deploy de producciÃ³n..."
            cd /srv/docker/saltoestudia
            
            echo "ğŸ“‹ Verificando archivos..."
            ls -la docker-compose.yml .env || echo "âš ï¸ Archivos de configuraciÃ³n no encontrados"
            
            echo "ğŸ›‘ Deteniendo contenedores anteriores..."
            docker compose down --remove-orphans || true
            docker rm -f saltoestudia-app || true
            
            echo "ğŸ”§ Construyendo nueva imagen..."
            docker compose build --no-cache
            
            echo "ğŸš€ Iniciando contenedores..."
            docker compose up -d
            
            echo "â³ Esperando que los contenedores estÃ©n listos..."
            sleep 10
            
            echo "ğŸ“Š Verificando estado de contenedores..."
            docker compose ps
            docker logs saltoestudia-app --tail 20 || echo "âš ï¸ No se pudieron obtener logs"
          '

      - name: Verificar deploy exitoso
        run: |
          ssh ${{ secrets.VPS_HOST }} '
            echo "ğŸ” Verificando que el deploy fue exitoso..."
            
            # Verificar que el contenedor estÃ¡ corriendo
            if docker ps | grep -q "saltoestudia-app"; then
              echo "âœ… Contenedor saltoestudia-app estÃ¡ corriendo"
            else
              echo "âŒ Contenedor saltoestudia-app NO estÃ¡ corriendo"
              exit 1
            fi
            
            # Verificar que Traefik puede acceder al contenedor
            echo "ğŸŒ Verificando conectividad con Traefik..."
            docker network inspect traefik-net | grep -A 5 -B 5 "saltoestudia-app" || echo "âš ï¸ Contenedor no encontrado en red Traefik"
            
            # Verificar logs sin errores crÃ­ticos
            echo "ğŸ“‹ Ãšltimos logs del contenedor:"
            docker logs saltoestudia-app --tail 10
            
            echo "ğŸ¯ Deploy de producciÃ³n verificado exitosamente"
          '

      - name: Notificar Ã©xito
        run: echo "ğŸš€ Deploy de producciÃ³n completado con Ã©xito en VPS" 